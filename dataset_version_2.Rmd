---
title: Airbnb business insights
author:
  - affiliation: UBC Sauder School of Business
    name: Teguh Samudra, Zhuoya Wang, Henry Deng, Suguna Menon
date: "October 2, 2019"
output:
  html_document:
    code_folding: show
    fig_caption: yes
    keep_md: yes
    self_contained: yes
    theme: readable
    toc: yes
    toc_float: yes
dev: svg
highlight: tango
---

## Problem Statement

What are the key factors that affect the demand for Airbnb among cities in the US?

We are interested in the business domain of home-sharing services. We decide to work on analyzing some key factors resulting in the different demand among US cities. By knowing analyzing these questions, we believe it will help improve Airbnbâ€™s performance in the cities with low demand.

## Data

```{r loadLibs}
knitr::opts_chunk$set(echo = TRUE,
                      results = 'hide',
                      message = FALSE,
                      warnings = FALSE)

library(RPostgreSQL)
library(knitr)
library(dplyr)
library(ggplot2)
library(lubridate)
library(readr)
library(tidyr)
library(stringi)
```

### Airbnb listings in US

The data comes from OpenDataSoft  (https://public.opendatasoft.com/explore/dataset/airbnb-listings/table/?disjunctive.host_verifications&disjunctive.amenities&disjunctive.features) and represents estimates of interprovincial migration from 1971 -- 2019.  Values in the table indicate the year and annual quarter of observation, the source province (in rows) and then the number of individuals migrating to each of the provinces and territories in Canada across the columns.

| Column       | Meaning                          |
|--------------|----------------------------------|
| id           | Unique identifier                |
| year         | Year of survey                   |
| quarter      | Annual quarter of survey (1 - 4) |
| origin       | Province of origin               |
| [NL -- Nvt.] | Province or territory (13 cols)  |
| Total        | Total migration                  |


```{r getAirbnbListing}

if (!dir.exists("data/input/")) {
  if (!dir.exists("data")) {
    dir.create("data")
  }
  dir.create("data/input")
}

if (!file.exists("data/input/airbnb-listings.csv")) {
  download.file("https://public.opendatasoft.com/explore/dataset/airbnb-listings/download/?format=csv&timezone=America/Los_Angeles&use_labels_for_header=true",
  "data/input/airbnb-listings.csv")
}

```

### Zipcode and location data for United States

Statistics Canada reports [monthly estimates of employment across Canadian provinces](https://www150.statcan.gc.ca/n1/en/tbl/csv/14100017-eng.zip?st=o0s47X7R).

Data is broken down by year and month, location, gender and age class.

| Column       | Meaning                          |
|--------------|----------------------------------|
| id           | Unique identifier                |
| year         | Year of survey                   |
| quarter      | Annual quarter of survey (1 - 4) |
| origin       | Province of origin               |
| [NL -- Nvt.] | Province or territory (13 cols)  |
| Total        | Total migration                  |


```{r getUSZipcodes}

if (!dir.exists("data/input/")) {
  if (!dir.exists("data")) {
    dir.create("data")
  }
  dir.create("data/input")
}

if (!file.exists("data/input/simplemaps_uszips_basicv1.6.zip")) {
  download.file("https://simplemaps.com/static/data/us-zips/1.6/basic/simplemaps_uszips_basicv1.6.zip",
  "data/input/simplemaps_uszips_basicv1.6.zip")
  unzip("data/input/simplemaps_uszips_basicv1.6.zip", exdir = "data/input")
}

```

### United States population

Statistics Canada reports [monthly estimates of employment across Canadian provinces](https://www150.statcan.gc.ca/n1/en/tbl/csv/14100017-eng.zip?st=o0s47X7R).

Data is broken down by year and month, location, gender and age class.


| Column       | Meaning                          |
|--------------|----------------------------------|
| id           | Unique identifier                |
| year         | Year of survey                   |
| quarter      | Annual quarter of survey (1 - 4) |
| origin       | Province of origin               |
| [NL -- Nvt.] | Province or territory (13 cols)  |
| Total        | Total migration                  |


```{r getUsPopulation}

if (!dir.exists("data/input/")) {
  if (!dir.exists("data")) {
    dir.create("data")
  }
  dir.create("data/input")
}

if (!file.exists("data/input/pop-by-zip-code.csv")) {
  download.file("https://query.data.world/s/alfepb4cfqwqaiegamf25yfoprleq2",
  "data/input/pop-by-zip-code.csv")
}
```

## Establishing connection with the database

We create a PostgreSQL database for our data.  Both datasets include geographic data, at the provincial level.

```{r dbConnect}

# Build will fail if the file isn't there.
assertthat::assert_that(file.exists('db_connect.txt'),
  msg = "Your connection file is missing.")

con_file <- readr::read_lines('db_connect.txt')

con <- RPostgreSQL::dbConnect(
             PostgreSQL(),
             host = con_file[1],
             port = con_file[2],
             user = con_file[3],
         password = con_file[4],
           dbname = con_file[5])

```

### Initial Data Cleaning

We want to remove NA values, and pare down the input data into a managable chunk.

### Airbnb Listings Data

We are going to remove some of the data.  In particular, any row that has an `NA` for the `VALUE` field in the labour market data.

**Look at the code below, what other things are happening?  Describe them**  *the functions `filter()`, `select()`, `mutate()` and `transmute()` all come from the `dplyr` package.*
The below code chunk checks if the data/input exists 


```{r cleanData}

if (!file.exists('data/output/airbnb-listings.rds')) {
  file_raw <- read.csv("data/input/airbnb-listings.csv",header = TRUE, sep = ';')
  file_reduced <- file_raw %>%
    #filter(Country.Code == 'US')
    select(host_id = 'Host.ID',
           host_since = "Host.Since",
           host_location = "Host.Location",
           host_response_time = "Host.Response.Time",
           host_listings_count = "Host.Listings.Count",
           host_total_listings_count = "Host.Total.Listings.Count",
           property_type = "Property.Type",
           room_type = "Room.Type",
           minimum_nights = "Minimum.Nights",
           number_of_reviews = "Number.of.Reviews",
           review_score_rating =  "Review.Scores.Rating",
           review_score_accuracy = "Review.Scores.Accuracy",
           review_score_cleanliness = "Review.Scores.Cleanliness",
           review_score_checkin = "Review.Scores.Checkin",
           review_score_location = "Review.Scores.Location",
           cancellation_policy = "Cancellation.Policy",
           city = "City",
           state = "State",
           zipcode = "Zipcode",
           latitude = "Latitude",
           longitude = "Longitude",
           accommodates = "Accommodates",
           price = "Price",
           country_code = "Country.Code"
           ) %>%
                filter(country_code == 'US') %>%
                  filter(!(property_type == 'Casa particular' |
                         property_type == 'Train' |
                         property_type == 'Plane' |
                         property_type == 'Parking Space' |
                         property_type == 'Van' |
                        property_type == '2017-04-02' |
                        property_type == 'Car'|
                         property_type == 'Boat')) %>%
                filter(stri_length(zipcode) == 5) %>%
                    mutate_each(state, funs = toupper)

  if (!file.exists('data/output')) {
    dir.create('data/output')
  }
  saveRDS(file_reduced, 'data/output/airbnb-listings.rds')
} else {
  file_reduced <- readRDS('data/output/airbnb-listings.rds')
}


#Create a new data frame that exclude Price == NA
file_cna2 <- file_reduced[!is.na(file_reduced$price),]
file_cna2$host_since <- as.Date(file_cna2$host_since, format = '%Y-%m-%d')
```

## Adding column property_id in the airbnb dataset

```{r add property_id}

file_cna2$property_id <- seq.int(nrow(file_cna2))

```

### Population Data

**Look at the code below, what is happening?  Describe it**  *the functions `filter()`, `select()`, and `mutate()` come from the `dplyr` package.  The function `gather()` comes from `tidyr`.*


```{r readPopulation}
if (!file.exists('data/output/population.rds')) {
  population_raw <- readr::read_csv("data/input/pop-by-zip-code.csv")

  population <- population_raw %>%
    select(zip_code_pop = 'zip_code',
           pop = 'y-2016')

  if (!file.exists('data/output')) {
    dir.create('data/output')
  }
  saveRDS(population, 'data/output/population.rds')
} else {
  population <- readRDS('data/output/population.rds')
}
```

### US Zipcodes Data

**Look at the code below, what is happening?  Describe it**  *the functions `filter()`, `select()`, and `mutate()` come from the `dplyr` package.  The function `gather()` comes from `tidyr`.*


```{r readLocation}
if (!file.exists('data/output/match_zip_city.rds')) {
  match_zip_city <- readr::read_csv("data/input/uszips.csv")

  us_zip <- match_zip_city %>%
    select(zip = 'zip',
           city = 'city',
           state_id = 'state_id',
           state_name = 'state_name',
           county_name = 'county_name'
           )

  if (!file.exists('data/output')) {
    dir.create('data/output')
  }
  saveRDS(us_zip, 'data/output/match_zip_city.rds')
} else {
  us_zip <- readRDS('data/output/match_zip_city.rds')
}

```

## Table Creation

When we push data into the database, we do the same thing each time.  We can wrap this in a function.  The function `post_data()` deletes the table and any keys or indexes we have made, before creating the table again.  This ensures you can run the script multiple times without errors.



## Creating function that will be called to write all the tables in the database

```{r postDataFunction to insert tables in the database}
post_data <- function(con, x, tablename = "") {
  if (dbExistsTable(con, tablename)) {
    dbExecute(con,
      paste0("DROP TABLE ", tablename,
             " CASCADE"))
  }

  dbWriteTable(con,
               tablename,
               x,
               row.names = FALSE,
               overwrite = TRUE)
}
```

## Write tables to the database

### Table: Reviews

```{r writeTableReview}

reviews <- file_cna2[c('property_id', 'review_score_rating', 'review_score_cleanliness', 'review_score_accuracy', 'review_score_checkin', 'review_score_location')]

post_data(con,
            data.frame(review_id = 1:nrow(reviews),reviews),
            "reviews")

dbExecute(con,
  "ALTER TABLE reviews ADD PRIMARY KEY (review_id)")
dbExecute(con,
  "CREATE UNIQUE INDEX review_idx ON reviews (review_id)")


```

### Table: Host

```{r writeTableHost}

host_data <- unique(file_cna2[c('host_id', 'host_since')])

post_data(con,
            host_data,
            "host")
dbExecute(con,
  "CREATE UNIQUE INDEX host_idx ON host (host_id)")
```

### Table: Host Details

```{r writeTableHostDetails}

host_desc <- unique(file_cna2[c('host_id', 'host_location', 'host_response_time', 'host_total_listings_count', 'host_listings_count')])

post_data(con,
            host_desc,
            "host_details")
```

### Table: Location

```{r writeTableLocation}

post_data(con,
            us_zip,
            "location")

dbExecute(con,
  "CREATE UNIQUE INDEX zip_x ON location (zip)")
```

### Table: Property

```{r writeTableProperty}

property <- file_cna2[c('property_id', 'zipcode', 'host_id', 'minimum_nights', 'property_type', 'room_type', 'accommodates', 'price', 'number_of_reviews', 'cancellation_policy')]

post_data(con,
            property,
            "property")

dbExecute(con,
  "ALTER TABLE property ADD PRIMARY KEY (property_id)")

dbExecute(con,
  "CREATE UNIQUE INDEX property_idx ON property (property_id)")
```

### Table: Population

```{r writeTablePopulation}

post_data(con,
            data.frame(population),
            "population")
dbExecute(con,
  "CREATE UNIQUE INDEX zip_code_popx ON population (zip_code_pop)")
```


## List all tables present in the database

```{r listTables, eval=FALSE}
dbListTables(con)
```


## Get data from database that will be used to do the analysis and plot graphs

```{r GetDataset1}

dataset1 = dbGetQuery(con, "
  SELECT L.city,
  	SUM(PR.number_of_reviews) AS no_of_bookings,
  	ROUND(CAST(AVG(POP.pop) AS NUMERIC), 2) AS pop_density,
  	ROUND(CAST(AVG(PR.price) AS NUMERIC), 2) AS price
  FROM property PR
  	INNER JOIN location L ON L.zip = PR.zipcode
  	INNER JOIN population POP ON L.zip = POP.zip_code_pop
  GROUP BY L.city
")

```


```{r GetDataset2}

dataset2 = dbGetQuery(con, "
  SELECT H.host_id,
    HD.host_total_listings_count,
    PR.property_id,
	  PR.price,
	  PR.room_type,
	  PR.minimum_nights,
	  PR.number_of_reviews AS no_of_bookings,
	  PR.cancellation_policy,
	  R.review_score_rating,
	  R.review_score_cleanliness,
	  R.review_score_accuracy,
	  R.review_score_checkin,
	  R.review_score_location
  FROM property PR
	INNER JOIN reviews R ON R.property_id = PR.property_id
	INNER JOIN host H ON H.host_id = PR.host_id
	INNER JOIN host_details HD ON H.host_id = HD.host_id
")

```

## Analysis

### Question One

**Does the review score rating affect the demand of Airbnb(total listings)? How does it affect the demand? Positively or negatively? Slightly or heavily?**

```{r}
review_vs_rating <- dataset2 %>%
                    filter(!is.na(review_score_rating) & !is.na(no_of_bookings))

ggplot(review_vs_rating, aes(x = review_score_rating, y = no_of_bookings)) + geom_point() +labs(x= 'Rating', y= 'Number of Bookings') + ggtitle("The Affect of Rating Score to Number of Bookings Received")
```


### Question Two

**Does price have a significant impact on the demand of Airbnb (total bookings) in NYC? In medium-sized cities? And small-sized ones?**

```{r}
price_vs_numberReviews <- dataset2 %>%
                    filter(!is.na(price) & !is.na(no_of_bookings))

ggplot(price_vs_numberReviews, aes(x = price)) + geom_histogram(stat = 'bin', binwidth = 30, col = 'red', fill = 'blue') +labs(x = 'Price (USD)',y='Number of Bookings') + ggtitle("Popular Price Range for AirBnb Listings")
```


### Question Three

**Do cities with larger population lead to more total bookings as compared to cities with lesser population? What is the trend?**

```{r}
dataset1_sorted <- dataset1 %>%
  arrange(desc(no_of_bookings)) %>%
  head(20)

ggplot(dataset1_sorted, aes(x = pop_density, y = no_of_bookings, color = price)) +geom_point(size = 5) + labs(x= 'Population Density', y= 'Number of Bookings') + ggtitle("Number of Bookings vs. Population Density in the Top 20 Cities")
```

### Question Four

**Comparing the minimum nights for 1/2/3/4/5/6, does specific minimum nights requirement have more demand as compared to others? Do customers intend to stay for longer prefer using Airbnb or customers with the need of one night stay?**

```{r}
minimum_nights_booking <- dataset2 %>%
                    filter(!is.na(minimum_nights) & !is.na(no_of_bookings)) %>%
                    filter(minimum_nights <= 30)

ggplot(minimum_nights_booking, aes(x = minimum_nights, y = no_of_bookings, color=room_type)) + geom_point() +labs(x = 'Minimum Night (Day)', y='Number of Bookings') + ggtitle("Length of Stay of Airbnb Users")
```

## Conclusions

# References

Statistics Canada. Table 051-0045 - Interprovincial migrants, by province or territory of origin and destination, quarterly (persons), CANSIM (database). (accessed: 2019 Q1)
